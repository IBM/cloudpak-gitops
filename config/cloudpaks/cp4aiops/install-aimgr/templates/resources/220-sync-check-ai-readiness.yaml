# https://www.ibm.com/docs/en/cloud-paks/cp-waiops/3.1.1?topic=installing-postinstallation-tasks
---
apiVersion: batch/v1
kind: Job
metadata:
  name: sync-check-aimgr-readiness
  annotations:
    argocd.argoproj.io/sync-wave: "220"
    argocd.argoproj.io/hook: Sync
  namespace: openshift-gitops
spec:
  template:
    spec:
      containers:
        - name: config
          image: quay.io/openshift/origin-cli:latest
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              memory: "64Mi"
              cpu: "250m"
            limits:
              memory: "96Mi"
              cpu: "300m"
          env:
            - name: TARGET_NAMESPACE
              value: "{{.Values.metadata.argocd_app_namespace}}"
            - name: WAIT_TIME
              value: "{{.Values.metadata.post_install_wait}}"
          command:
            - /bin/sh
            - -c
            - |
              set -eo pipefail
              set -x

              result=0

              current_seconds=0
              operation_limit_seconds=$(( $(date +%s) + 7200 ))
              pods_found=0
              while [ ${current_seconds} -lt ${operation_limit_seconds} ]; do
                if oc get AIOpsAnalyticsOrchestrator \
                      -l app.kubernetes.io/instance=aiops \
                      -n "${TARGET_NAMESPACE}" &&
                   oc get route -n "${TARGET_NAMESPACE}" cpd; then
                   pods_found=1
                else
                   pods_found=0
                fi
                if [ ${pods_found} -eq 0 ]; then
                  echo "INFO: AI Manager resources not ready, waiting some more."
                  sleep 60
                else
                  echo "INFO: AI Manager resources found."
                  break;
                fi
                current_seconds=$(( $(date +%s) ))
              done

              echo "INFO: Checking AI Manager resources."
              oc wait AIOpsAnalyticsOrchestrator \
                -l app.kubernetes.io/instance=aiops \
                -n "${TARGET_NAMESPACE}" \
                --for condition=Ready=true \
                --timeout="${WAIT_TIME}" \
              || result=1

              if [ ${result} -eq 0 ]; then
                echo "INFO: All AI Manager resources are ready."
              else
                echo "ERROR: AI Manager resources not ready after specified period."
                oc get AIOpsAnalyticsOrchestrator \
                      -l app.kubernetes.io/instance=aiops \
                      -n "${TARGET_NAMESPACE}" || result=1
                oc get route -n "${TARGET_NAMESPACE}" cpd || result=1
              fi

              echo "INFO: Verification steps from the guide: https://www.ibm.com/docs/en/cloud-paks/cloud-pak-watson-aiops/3.3.0?topic=installation-online-cli#verify"
              oc get installations.orchestrator.aiops.ibm.com -n "${TARGET_NAMESPACE}" \
              && echo "" \
              &&  oc get ircore,AIOpsAnalyticsOrchestrator -n "${TARGET_NAMESPACE}" -o custom-columns="KIND:kind,NAMESPACE:metadata.namespace,NAME:metadata.name,STATUS:status.conditions[?(@.type==\"Ready\")].reason" \
              && echo "" \
              && oc get lifecycleservice -n "${TARGET_NAMESPACE}" -o custom-columns="KIND:kind,NAMESPACE:metadata.namespace,NAME:metadata.name,STATUS:status.conditions[?(@.type==\"Lifecycle Service Ready\")].reason" \
              && echo "" \
              && oc get BaseUI -n "${TARGET_NAMESPACE}" -o custom-columns="KIND:kind,NAMESPACE:metadata.namespace,NAME:metadata.name,STATUS:status.conditions[?(@.type==\"Ready\")].reason" \
              && echo "" \
              && oc get AIManager,aiopsedge,asm -n "${TARGET_NAMESPACE}" -o custom-columns="KIND:kind,NAMESPACE:metadata.namespace,NAME:metadata.name,STATUS:status.phase"

              exit "${result}"

      restartPolicy: Never
      serviceAccountName: {{.Values.serviceaccount.ibm_cloudpaks_installer}}
  backoffLimit: 1
